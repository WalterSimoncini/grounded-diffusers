# Grounded Diffusers

This repository builds on top of the paper [Guiding Text-to-Image Diffusion Model Towards Grounded Generation
](https://arxiv.org/abs/2301.05221) whose code is available [here](https://github.com/Lipurple/Grounded-Diffusion) and re-implements it using the HuggingFace's [diffusers](https://github.com/huggingface/diffusers) library in addition to several improvements including:

- Decoupled dataset generation and training
- Support for multiple objects in an image
- Multi-epoch training
- Choice of loss function (BCE, Dice, Dice + BCE, Log-Cosh + BCE)

The details of our contribution are elaborated on in the [project's paper](https://github.com/WalterSimoncini/grounded-diffusers/blob/master/paper.pdf)

## Qualitative Results

The original image and the segmentation masks generated by our grounding model for one or two classes. The model is able to ground long tail objects such as a sushi platter, eurofighter, batman and super mario.

![](./media/qualitative_results.png)


## Environment setup

To create a suitable environment to run the code install conda and create an environment as follows:

```sh
conda create --name gdiff python==3.10
sh setup_env.sh
```

The setup script will install the required dependencies and download Mask R-CNN and grounding checkpoints. The latter was trained on 10k images with two objects from different classes selected between the first 15 classes of the split 1 of Pascal VOC, located in `VOC/class_split1.csv`. The grounding module was trained using Stable Diffusion 1.5, so it's not compatible with Stable Diffusion 2.

## Running the code

### Generate & Segment

Once you've set up the environment you can generate and segment an image using the `generate_and_segment.py` script as follows:

```sh
python generate_and_segment.py \
    --prompt "a photograph of a basketball with a cat standing on top of it on a field long shot" \
    --classes "cat,basketball" \
    --grounding-ckpt "mmdetection/checkpoint/grounding_module.pth" \
    --seed 2147483647
```

This will output images overlayed with the masks generated by the segmentation module and Mask R-CNN, alongside the segmented items (using the segmentation module). The command above will generate the image and masks below

![](./media/segmentation_example.png)

### Training a new module

To train a new grounding module you'll first have to generate a dataset using the `generate_dataset.py` script. You will need both a training and a validation dataset. At this time we are not able to offer the download of a mock dataset due to the size of an individual image (alongside its UNet features) being ~54 MBs. Run the script as follows:

```sh
# Use stabilityai/stable-diffusion-2 for Stable Diffusion 2
python generate_dataset.py \
    --output-dir "mock" \
    --n-classes 2 \
    --total-samples 50 \
    --dataset-type "seen" \
    --model-name "runwayml/stable-diffusion-v1-5"
```

This script will only save generated samples for which Mask R-CNN can find masks for both picked classes. Once you've generate a training and a validation dataset train the grounding module as follows:

```sh
# Use the --visualize-examples flag to display a mask every 25 steps
python train_grounding_multiclass.py \
    --dropout 0.2 \
    --n-epochs 10 \
    --run-name "mock" \
    --train-images-path "train/images/" \
    --train-samples-path "train/samples/" \
    --validation-samples-path "val/samples/" \
    --seed 42
```

Once you've trained the model you can use the `evaluate_multi_class.py` script to calculate the mIoU on a test dataset

```sh
python evaluate_multi_class.py \
    --grounding-ckpt "mmdetection/checkpoint/grounding_module.pth" \
    --model-name "runwayml/stable-diffusion-v1-5" \
    --samples-path "val/samples/"
```

## Miscellaneous

### Prompts to generate the poster images

```json
[
    {
        "prompt": "a photograph of a basketball with a cat standing on top of it on a field long shot",
        "classes": "cat,basketball"
    },
    {
        "prompt": "a photograph of a mug and a pottedplant side by side sitting on top of a table in a kitchen with strong natural light. In the background a white wall can be seen",
        "classes": "mug,pottedplant"
    },
    {
        "prompt": "a photograph of a monkey sitting side by side with a bunch of bananas. there is a strong natural warm light in the scene. high quality photography 8k",
        "classes": "monkey,banana"
    },
    {
        "prompt": "a photograph of a red car and an eagle flying in the sky",
        "classes": "eagle,car"
    },
    {
        "prompt": "a photograph of a dog sitting on top of a boat sailing on a river, lit by a warm natural light long shot",
        "classes": "dog,boat"
    }
]
```

### Commands used to generate the paper images

```sh
python generate_and_segment.py \
    --prompt "a photograph of a bear in a pine forest observing an abandoned refrigerator" \
    --classes "bear,refrigerator" \
    --mask-rcnn-classes "bear,refrigerator" \
    --n-images 5

python generate_and_segment.py \
    --prompt "a photograph of a tennisplayer hitting a tennis ball with his racket" \
    --classes "racket,person" \
    --mask-rcnn-classes "person,tennis racket" \
    --n-images 5
```

```sh
python generate_and_segment.py \
    --prompt "a turtle climbing on top of a reef in the pacific ocean. photorealistic digital art, cinematic, extremely high detail, cinematic lighting, trending, artstation, cgsociety, 3 d ue 5, 4 k, hq" \
    --classes "turtle" \
    --skip-mask-rcnn \
    --n-images 3

python generate_and_segment.py \
    --prompt "a flamingo standing next to a yacht. photorealistic digital art, cinematic, extremely high detail, cinematic lighting, trending, artstation, cgsociety, 3 d ue 5, 4 k, hq" \
    --classes "flamingo,yacht" \
    --skip-mask-rcnn \
    --n-images 5

python generate_and_segment.py \
    --prompt "a long shot photograph of an elephant standing in front of the pyramids. photorealistic digital art, cinematic, extremely high detail, cinematic lighting, trending, artstation, cgsociety, 3 d ue 5, 4 k, hq" \
    --classes "elephant" \
    --skip-mask-rcnn \
    --n-images 5

python generate_and_segment.py \
    --prompt "a long shot photograph of an elephant standing in front of an eurofighter jet. photorealistic digital art, cinematic, extremely high detail, cinematic lighting, trending, artstation, cgsociety, 3 d ue 5, 4 k, hq" \
    --classes "elephant,eurofighter" \
    --skip-mask-rcnn \
    --n-images 5

python generate_and_segment.py \
    --prompt "a wooden barrel next to a cactus outside of a saloon in late 1800s austin texas. cinematic, extremely high detail, cinematic lighting, trending, artstation, cgsociety, colorful, 4k, hq" \
    --classes "barrel,cactus" \
    --skip-mask-rcnn \
    --n-images 5

python generate_and_segment.py \
    --prompt "a photograph of a plate of carbonara pasta. cinematic, extremely high detail, cinematic lighting, trending, artstation, cgsociety, colorful, 4k, hq" \
    --classes "carbonara" \
    --skip-mask-rcnn \
    --n-images 5

python generate_and_segment.py \
    --prompt "a photograph of a lamborghini murcielago. cinematic, extremely high detail, cinematic lighting, trending, artstation, cgsociety, colorful, 4k, hq" \
    --classes "lamborghini" \
    --skip-mask-rcnn \
    --n-images 5

# Generated with the fine-tuned checkpoint
# https://civitai.com/models/4823/deliberate
python generate_and_segment.py \
    --prompt "a long shot photograph of a man standing in front of of a ferrari testarossa. cinematic, extremely high detail, cinematic lighting, trending, artstation, cgsociety, colorful, 4k, hq" \
    --classes "ferrari,person" \
    --skip-mask-rcnn \
    --n-images 5

python generate_and_segment.py \
    --prompt "a long shot photograph of lion chasing a zebra in the african savannah. cinematic, extremely high detail, cinematic lighting, trending, artstation, cgsociety, colorful, 4k, hq" \
    --classes "lion,zebra" \
    --skip-mask-rcnn \
    --n-images 5

python generate_and_segment.py \
    --prompt "a photograph of a sushi platter next to an ashai beer can on top of a table. cinematic, extremely high detail, cinematic lighting, trending, artstation, cgsociety, colorful, 4k, hq" \
    --classes "sushi,beercan" \
    --skip-mask-rcnn \
    --n-images 5

python generate_and_segment.py \
    --prompt "a photograph of an alpaca standing next to a park bench. cinematic, extremely high detail, cinematic lighting, trending, artstation, cgsociety, colorful, 4k, hq" \
    --classes "alpaca,parkbench" \
    --skip-mask-rcnn \
    --n-images 5

python generate_and_segment.py \
    --prompt "a portrait of an explorer dressed in the style of indiana jones wearing a hat in front of an egyptian sphinx. photorealistic digital art, cinematic, extremely high detail, cinematic lighting, trending, artstation, cgsociety, colorful, 4k, hq" \
    --classes "explorer" \
    --skip-mask-rcnn \
    --n-images 5
```
